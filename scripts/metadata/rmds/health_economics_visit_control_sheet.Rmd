---
title: ""
output: pdf_document
geometry: margin=1cm
classoption: landscape
---

```{r, eval = FALSE, echo = FALSE}
header-includes:
- \usepackage{booktabs}
- \usepackage{xcolor}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage[normalem]{ulem}

```


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = NA, 
               echo = FALSE, 
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE,
  fig.path = "figures/",
  out.width = "100%"
)
options(knitr.kable.NA = '')
```

\thispagestyle{empty}


```{r}
library(dplyr)
library(knitr)
options(digits=8)

library(kableExtra)
library(readr)
library(dplyr)
# Define function for adding zero
add_zero <- function (x, n) {
  x <- as.character(x)
  adders <- n - nchar(x)
  adders <- ifelse(adders < 0, 0, adders)
  for (i in 1:length(x)) {
    if (!is.na(x[i])) {
      x[i] <- paste0(paste0(rep("0", adders[i]), collapse = ""),
                     x[i], collapse = "")
    }
  }
  return(x)
}
```

```{r}
# Read in data generated by generate_metadata.R
load('health_economics_tables.RData')

# Read in NTD pre-selections
ntd_efficacy_preselection <- read_csv('../../../analyses/randomization/outputs/health_economics_ntd_efficacy_preselection.csv')
ntd_safety_preselection <- read_csv('../../../analyses/randomization/outputs/health_economics_ntd_safety_preselection.csv')

# Get number of ntd individuals per household
ntd_ids <- sort(unique(c(ntd_efficacy_preselection$extid, ntd_safety_preselection$extid)))
ndx <- v0demography_repeat_individual %>%
  left_join(v0demography %>% dplyr::select(KEY, hhid), by = c('PARENT_KEY' = 'KEY')) %>%
  mutate(in_ntd = extid %in% ntd_ids) %>%
  group_by(hhid) %>%
  summarise(n_ntd = length(which(in_ntd)))
  

# Read in hard-coded files supplied by Paula for organizing visit control sheets:
# https://bohemiakenya.slack.com/archives/C058WT0ADBN/p1693470284107819
cluster9 <- read_delim('health_economics_supplementary_vcs_data/HEcon VCS cluster 9.csv', delim = ';') %>%
  mutate(VCS = ifelse(VCS == 'VCS_1', '09A', 
                      ifelse(VCS == 'VCS_2', '09B',
                             NA))) %>%
  mutate(hhid = add_zero(hhid, 5))
cluster73 <- read_delim('health_economics_supplementary_vcs_data/HEcon VCS cluster 73.csv', delim = ';') %>%
  mutate(VCS = ifelse(VCS == 'VCS_1', '73A',
                      ifelse(VCS == 'VCS_2', '73B',
                             ifelse(VCS == 'VCS_3', '73C', NA)))) %>%
  mutate(hhid = add_zero(hhid, 5))
vcs <- read_delim('health_economics_supplementary_vcs_data/HEcon VCS per cluster.csv', delim = ';')

# The project wants some clusters to have their own visit control sheet, and others to split
# Handle this:
exceptions <- bind_rows(cluster9, cluster73)
households <- left_join(households, exceptions) %>%
  mutate(VCS = ifelse(is.na(VCS), cluster, VCS))

# Narrow down to just the columns specified here: https://docs.google.com/spreadsheets/d/1Ok1JAq4RhAv0dMnVRjl38Ig-6XdEyvBJbCtMzFql9k4/edit#gid=0
subs <- v0demography_repeat_individual %>%
  filter(!is.na(hh_head_sub_yn)) %>%
  filter(hh_head_sub_yn == 'yes') %>%
  left_join(v0demography %>% dplyr::select(KEY, hhid), by = c('PARENT_KEY' = 'KEY')) %>%
  mutate(full_name = paste0(firstname, ' ', lastname)) %>%
  mutate(full_name = stringr::str_replace_all(full_name, "[^[:alnum:]]", "")) %>%
  mutate(full_name = toupper(full_name)) %>%
    # mutate(full_name = gsub(r"(\\)", '', full_name)) %>%
  group_by(hhid) %>%
  summarise(hh_sub = paste0(full_name, collapse = ', '))
households <- households %>%
  arrange(hhid) %>%
  # get some information from v0demograph
  left_join(v0demography %>%
              dplyr::select(hhid, village, own_cattle)) %>%
  left_join(subs) %>%
  mutate(own_cattle = ifelse(is.na(own_cattle), 'no', own_cattle)) %>%
  mutate(own_cattle = Hmisc::capitalize(own_cattle)) %>%
  left_join(ndx) %>%
  mutate(dummy = 1) %>%
  group_by(VCS) %>%
  mutate(index = cumsum(dummy)) %>%
  ungroup %>%
  dplyr::select(
    VCS, 
    `No.` = index,
    `Hh_ID` = hhid,
    Village = village,
    `Head of Hh` = household_head,
    `Head of Hh sub` = hh_sub,
    `Hh members` = num_members,
    `NTD-preselected members` = n_ntd,
    `Cattle-owning` = own_cattle
  ) %>%
  mutate(`Head of Hh` = stringr::str_replace_all(`Head of Hh`, "[^[:alnum:]]", "")) %>%
  mutate(
    `1` = '',
      `2` = '',
      `3` = '',
    Refusal = '',
    `New hh member(s)` = '',
    `Herd eligible` = '',
    `Date hh visit` = '',
    Notes = ''
  ) 

# Create the individual table too
persons <- v0demography_repeat_individual %>%
  left_join(v0demography %>% dplyr::select(hhid, village, cluster, KEY), by = c('PARENT_KEY' = 'KEY')) %>%
  mutate(cluster = add_zero(cluster, 2)) %>%
  arrange(hhid, extid) %>%
  filter(hhid %in% households$Hh_ID) %>%
  left_join(exceptions) %>%
  mutate(VCS = ifelse(is.na(VCS), cluster, VCS)) %>%
  mutate(dummy = 1) %>%
  group_by(VCS) %>%
  mutate(index = cumsum(dummy)) %>%
  ungroup %>%
  mutate(full_name = paste0(firstname, ' ', lastname)) %>%
  mutate(full_name = stringr::str_replace_all(full_name, "[^[:alnum:]]", "")) %>%
  # mutate(full_name = gsub(r"(\\)", '', full_name)) %>%
    mutate(full_name = toupper(full_name)) %>%
  mutate(age = as.numeric(floor((Sys.Date() - dob) / 365.25))) %>%
  mutate(ntd_preselected = ifelse(extid %in% ntd_ids, 'Yes', 'No')) %>%
  dplyr::select(`No.` = index,
                `Ext ID` = extid,
                Village = village,
                `Member name` = full_name,
                Age = age,
                `NTD preseected` = ntd_preselected, 
                VCS) %>%
    mutate(
    `1` = '',
      `2` = '',
      `3` = '',
    Refusal = '',
    `Date individual visit` = '',
    Notes = ''
  ) 

# Fake names for anonimization
if(FALSE){
  fake_names <- babynames::babynames
  fake_names <- sort(unique(fake_names$name))
  out <- c()
  for(i in 1:10000){
    out[i] <- paste0(sample(fake_names, 1), ' ', sample(fake_names, 1))
  }
  fake_names <- out
  households$`Head of Hh` <- sample(fake_names, nrow(households))
  households$`Head of Hh sub` <- sample(fake_names, nrow(households))
  persons$`Member name` <- sample(fake_names, nrow(persons))
}

vcs_documents <- sort(unique(households$VCS))

```


```{r results='asis', eval = TRUE}  
cat('\n\n')
# Print the titles/tables
for (i in 1:length(vcs_documents)) {
  this_cluster <- vcs_documents[i]
  this_data <- households %>% filter(VCS == this_cluster) %>%
    dplyr::select(-VCS)
  n_hh <- nrow(this_data)
  these_persons <- persons %>% filter(VCS == this_cluster) %>%
    dplyr::select(-VCS)
  # names(this_data) <- gsub('_', ' ', names(this_data))

  # Household table
  # names(this_data) <- Hmisc::capitalize(names(this_data))
  k <- kable(this_data, format = "latex",
              longtable = TRUE,
              booktabs = TRUE,
              #align = "c", 
             escape = TRUE,
          row.names = FALSE) %>%
      kable_styling(latex_options = c(#"scale_down",
                'repeat_header',

                                       "striped"
                                      ), 
                     # full_width = T,
                    font_size = 7) %>%
    add_header_above(c(" " = 8, "Absences" = 3, " " = 5)) %>%
    column_spec(1,  width = "1em")  %>%
    column_spec(2,  width = "3em")  %>%
    column_spec(3,  width = "5em")  %>%
    column_spec(4,  width = "9em")  %>%
    column_spec(5,  width = "9em")  %>%
    column_spec(6,  width = "3em")  %>%
    column_spec(7,  width = "5em")  %>%
    column_spec(8,  width = "3em")  %>%
    column_spec(9,  width = "1em")  %>%
    column_spec(10,  width = "1em")  %>%
    column_spec(11,  width = "1em")  %>%
    column_spec(12,  width = "3em")  %>%
    column_spec(13,  width = "3em")  %>%
    column_spec(14,  width = "3em")  %>%
    column_spec(15,  width = "15em")  
  
  # Individual table
    k2 <- kable(these_persons, format = "latex",
              longtable = TRUE,
              booktabs = TRUE,
              #align = "c", 
             escape = TRUE,
          row.names = FALSE) %>%
      kable_styling(latex_options = c(#"scale_down",
        'repeat_header',
                                       "striped"
                                      ), 
                     # full_width = T,
                    font_size = 7) %>%
    add_header_above(c(" " = 6, "Absences" = 3, " " = 3)) %>%
    column_spec(1,  width = "1em")  %>%
    column_spec(2,  width = "5em")  %>%
    column_spec(3,  width = "5em")  %>%
    column_spec(4,  width = "8em")  %>%
    column_spec(5,  width = "3em")  %>%
    column_spec(6,  width = "3em")  %>%
    column_spec(7,  width = "1em")  %>%
    column_spec(8,  width = "1em")  %>%
    column_spec(9,  width = "1em")  %>%
    column_spec(10,  width = "4em")  %>%
    column_spec(11,  width = "5em")  %>%
    column_spec(12,  width = "27em")  
    
    # New members tabble
    new_members <- tibble(
      `No.` = 1:15,
      `Ext ID` = ' ',
      `Member name` = ' ',
      `HH member age` = ' ',
      `Refused` = ' ',
      `Date visited` = ' ',
      `Notes` = ' '
    )
    k3 <- kable(new_members, format = "latex",
              longtable = TRUE,
              booktabs = TRUE,
              #align = "c", 
             escape = TRUE,
          row.names = FALSE) %>%
      kable_styling(latex_options = c(#"scale_down",
        'repeat_header',
                                       "striped"
                                      ), 
                     # full_width = T,
                    font_size = 7) %>%
    column_spec(1,  width = "1em")  %>%
    column_spec(2,  width = "7em")  %>%
    column_spec(3,  width = "15em")  %>%
    column_spec(4,  width = "5em")  %>%
    column_spec(5,  width = "5em")  %>%
    column_spec(6,  width = "8em")  %>%
    column_spec(7,  width = "30em") 
  
  cat(paste0("\\fbox{\\parbox{5cm}{\\centering Cluster No. ", this_cluster, ' HOUSEHOLDS',  "}}\n\n"))
  cat(paste0("\\medskip\n\n"))
  cat(paste0('(Number of households: ',n_hh, ')'))
  cat(paste0("\\medskip\n\n"))
  cat(paste0('Health Economics Baseline (V1) Visit Control Sheet'))
  # k <- paste0(paste0('Cluster ', this_cluster, '\\', k))
  print(k)
  cat('\\newpage')
  cat(paste0("\\fbox{\\parbox{5cm}{\\centering Cluster No. ", this_cluster, ' INDIVIDUALS',  "}}\n\n"))

  print(k2)
  # cat('\\')
    cat('\\newpage')

    cat(paste0("\\fbox{\\parbox{5cm}{\\centering Cluster No. ", this_cluster, ' NEW MEMBERS',  "}}\n\n"))

  print(k3)
  cat('\\newpage')

}
```


\end{Center}