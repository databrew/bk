---
title: ""
output: pdf_document
geometry: margin=1cm
classoption: landscape
---

```{r, eval = FALSE, echo = FALSE}
header-includes:
- \usepackage{booktabs}
- \usepackage{xcolor}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage[normalem]{ulem}

```


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = NA, 
               echo = FALSE, 
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE,
  fig.path = "figures/",
  out.width = "100%"
)
options(knitr.kable.NA = '')
```

```{r}
library(dplyr)
library(knitr)
options(digits=8)

library(kableExtra)
library(readr)
library(dplyr)
# Define function for adding zero
add_zero <- function (x, n) {
  x <- as.character(x)
  adders <- n - nchar(x)
  adders <- ifelse(adders < 0, 0, adders)
  for (i in 1:length(x)) {
    if (!is.na(x[i])) {
      x[i] <- paste0(paste0(rep("0", adders[i]), collapse = ""),
                     x[i], collapse = "")
    }
  }
  return(x)
}
```

```{r}
# Read in data generated by generate_metadata.R
load('health_economics_tables.RData')

# Read in NTD pre-selections
ntd_efficacy_preselection <- read_csv('../../../analyses/randomization/outputs/health_economics_ntd_efficacy_preselection.csv')
ntd_safety_preselection <- read_csv('../../../analyses/randomization/outputs/health_economics_ntd_safety_preselection.csv')

# Read in hard-coded files supplied by Paula for organizing visit control sheets:
# https://bohemiakenya.slack.com/archives/C058WT0ADBN/p1693470284107819
cluster9 <- read_delim('health_economics_supplementary_vcs_data/HEcon VCS cluster 9.csv', delim = ';') %>%
  mutate(VCS = ifelse(VCS == 'VCS_1', '09A', 
                      ifelse(VCS == 'VCS_2', '09B',
                             NA))) %>%
  mutate(hhid = add_zero(hhid, 5))
cluster73 <- read_delim('health_economics_supplementary_vcs_data/HEcon VCS cluster 73.csv', delim = ';') %>%
  mutate(VCS = ifelse(VCS == 'VCS_1', '73A',
                      ifelse(VCS == 'VCS_2', '73B',
                             ifelse(VCS == 'VCS_3', '73C', NA)))) %>%
  mutate(hhid = add_zero(hhid, 5))
vcs <- read_delim('health_economics_supplementary_vcs_data/HEcon VCS per cluster.csv', delim = ';')

# The project wants some clusters to have their own visit control sheet, and others to split
# Handle this:
exceptions <- bind_rows(cluster9, cluster73)
households <- left_join(households, exceptions) %>%
  mutate(VCS = ifelse(is.na(VCS), cluster, VCS))

# Narrow down to just the columns specified here: https://docs.google.com/spreadsheets/d/1Ok1JAq4RhAv0dMnVRjl38Ig-6XdEyvBJbCtMzFql9k4/edit#gid=0
subs <- v0demography_repeat_individual %>%
  filter(!is.na(hh_head_sub_yn)) %>%
  filter(hh_head_sub_yn == 'yes') %>%
  left_join(v0demography %>% dplyr::select(KEY, hhid), by = c('PARENT_KEY' = 'KEY')) %>%
  mutate(full_name = paste0(firstname, ' ', lastname)) %>%
  mutate(full_name = toupper(full_name)) %>%
  group_by(hhid) %>%
  summarise(hh_sub = paste0(full_name, collapse = ', '))
households <- households %>%
  arrange(hhid) %>%
  # get some information from v0demograph
  left_join(v0demography %>%
              dplyr::select(hhid, village, own_cattle)) %>%
  left_join(subs) %>%
  mutate(own_cattle = ifelse(is.na(own_cattle), 'no', own_cattle)) %>%
  mutate(own_cattle = Hmisc::capitalize(own_cattle))

vcs_documents <- sort(unique(households$VCS))

```




```{r results='asis', eval = TRUE}  
# Print the titles/tables
for (i in 1:length(vcs_documents)) {
  this_cluster <- vcs_documents[i]
  this_data <- households %>% filter(VCS == this_cluster) %>%
    dplyr::select(hhid, num_members, arm, intervention)

  names(this_data) <- gsub('_', ' ', names(this_data))

  names(this_data) <- Hmisc::capitalize(names(this_data))
  k <- kable(this_data, format = "latex",
              longtable = TRUE,
              booktabs = TRUE,
              #align = "c", 
          row.names = FALSE) %>%
      kable_styling(latex_options = c(#"scale_down",
                                       "striped"
                                      ), 
                     # full_width = T, 
                    font_size = 7) 
  cat(paste0("\\fbox{\\parbox{5cm}{\\centering Cluster No. ", this_cluster, "}}\n\n"))
  cat(paste0("\\medskip\n\n"))
  cat(paste0('Health Economics Baseline (V1) Visit Control Sheet'))
  # k <- paste0(paste0('Cluster ', this_cluster, '\\', k))
  print(k)
  cat('\\newpage')
}
```

\end{Center}
