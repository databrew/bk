---
title: ""
output: 
  pdf_document:
    latex_engine: xelatex
header-includes:
- \usepackage{array}
- \usepackage{booktabs}
- \usepackage{threeparttablex}
- \usepackage{pdflscape}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \usepackage{lastpage}
- \usepackage{multirow}
- \usepackage{colortbl}
- \usepackage[labelformat = empty]{caption}
- \fancyhead[CO,CE]{Adverse events}
- \fancyfoot[CO,CE]{Date = \today\\}
- \fancyfoot[LE,RO]{Page {\thepage} of \pageref{LastPage}}
geometry: margin=2cm
classoption: landscape
params:
  vcs: 02A
always_allow_html: true
---

\thispagestyle{fancy}




```{r, eval = FALSE, echo = FALSE}
header-includes:
- \usepackage{booktabs}
- \usepackage{xcolor}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage[normalem]{ulem}
- \thispagestyle{empty}

```


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = NA, 
               echo = FALSE, 
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE,
  fig.path = "figures/",
  fig.height = 7.5,
  fig.width = 9,
  out.width = "100%"
)
options(knitr.kable.NA = '')
library(knitr)
library(kableExtra)
```



```{r}
library(dplyr)
library(knitr)
options(digits=8)

library(kableExtra)
library(readr)
library(dplyr)
library(ggplot2)
# Define function for adding zero
add_zero <- function (x, n) {
  x <- as.character(x)
  adders <- n - nchar(x)
  adders <- ifelse(adders < 0, 0, adders)
  for (i in 1:length(x)) {
    if (!is.na(x[i])) {
      x[i] <- paste0(paste0(rep("0", adders[i]), collapse = ""),
                     x[i], collapse = "")
    }
  }
  return(x)
}
```

```{r}
# Read in data generated by identify_adverse_events.R
load('rmd_data.RData')

# Manual modifications to categories based on Carlos' instructions
# https://bohemiakenya.slack.com/archives/C042KSRLYUA/p1718715804095149?thread_ts=1718714760.756079&cid=C042KSRLYUA
ae <- ae %>%
  mutate(symptom_category = ifelse(symptom_category %in% c('Diarrhea', 'Nausea/vomiting'),
                                   'Gastrointestinal', symptom_category))
```



# Aggregated information

## Incidence rates

The below table shows incident rates for severe adeverse events (`xsaes`) and adverse events (`xaes`).

```{r}
# Read in intervention information
assignments <- read_csv('../randomization/outputs/assignments.csv')
ia <- read_csv('../randomization/outputs/intervention_assignment.csv')

# Read in Carlos categories
carlos <- read_csv('data/20240613_carlos_aes_CCh_marked_as_1_non_AEs.csv')
# Remove from analysis those events considered by Carlos to be non-AEs
remove_these <- carlos %>% filter(!is.na(AE)) %>% mutate(remove = TRUE) %>% dplyr::select(-todays_date)
ae <- ae %>% left_join(remove_these) %>%
  filter(is.na(remove)) %>%
  filter(!is.na(extid))

# Read in SAEs from Laura (corrected by Carlos 2024-06-14)
saes <- read_csv('data/20240614_SAE Line Listing for Joe corrected.csv') %>%
# saes <- readxl::read_excel('data/20240613_SAE Line Listing for Joe.xlsx') %>%
  # Get intervention
  mutate(cluster_number = as.numeric(substr(extID, 1, 2))) %>%
  left_join(assignments) %>%
  dplyr::rename(arm = assignment) %>%
  left_join(ia) %>%
  mutate(symptom_category =
           ifelse(!is.na(`Event Death`), 'Death',
                  ifelse(!is.na(`Event Hospitalized`), 'Hospitalization', NA)))

# Remove pregnancy related SAEs as per https://bohemiakenya.slack.com/archives/C042KSRLYUA/p1717910963530969?thread_ts=1717753800.699009&cid=C042KSRLYUA
# No longer necessary, Carlos removed them

# Get total number of people treated
denominator <- safety_repeat_individual %>%
  left_join(safety, by = c('PARENT_KEY' = 'KEY')) %>%
  mutate(took_drug =  participant_take_drug == 'yes' | participant_take_drug_2 == 'yes') %>%
  filter(took_drug) %>%
  group_by(intervention) %>%
  summarise(people = length(unique(extid)))
  


# Rate (SAEs)
numerator <- saes %>% group_by(intervention) %>% summarise(saes = n())
# Rate (AEs)
numerator2 <- ae %>% 
    # Get intervention
  mutate(cluster_number = as.numeric(substr(extid, 1, 2))) %>%
  left_join(assignments) %>%
  dplyr::rename(arm = assignment) %>%
  left_join(ia) %>%
  filter(!is.na(intervention)) %>%
  group_by(intervention) %>%
  summarise(aes = n())

joined <- left_join(numerator, numerator2)
joined <- left_join(joined, denominator)
joined <- joined %>%
  mutate(saes_rate = saes / people,
         aes_rate = aes / people)
# Get 95% confidence intervals
library(binom)
options(scipen = '999')
ci_saes <- binom.confint(x = joined$saes, n = joined$people, methods = 'wilson') %>%
  dplyr::select(upr_saes = upper, lwr_saes = lower)
ci_aes <- binom.confint(x = joined$aes, n = joined$people, methods = 'wilson') %>%
  dplyr::select(upr_aes = upper, lwr_aes = lower)
joined <- bind_cols(joined, ci_saes, ci_aes)
joined %>%
  mutate(xsaes = paste0(round(saes_rate, digits = 4), ' (', round(lwr_saes, digits = 4), '-', round(upr_saes, digits = 4), ')')) %>%
  mutate(xaes = paste0(round(aes_rate, digits = 4), ' (', round(lwr_aes, digits = 4), '-', round(upr_aes, digits = 4), ')')) %>%
  dplyr::select(intervention, saes, aes, people, xsaes, xaes) %>%
  knitr::kable()
```


## SAEs by sub-category

```{r}
sub_categories <- sort(unique(saes$symptom_category))
out_list <- list()
for(i in 1:length(sub_categories)){
  this_sub_category <- sub_categories[i]
  this_sae <- saes %>%
    filter(symptom_category == this_sub_category)
  numerator <- this_sae %>% 
  group_by(intervention) %>%
  summarise(aes = n()) 
  joined <- left_join(numerator, denominator) %>%
    mutate(rate = aes / people)
  ci <- binom.confint(x = joined$aes, n = joined$people, methods = 'wilson') %>%
  dplyr::select(upr = upper, lwr = lower)
  joined <- bind_cols(joined, ci)
  joined <- joined %>%
    mutate(sub_category = this_sub_category)
  out_list[[i]] <- joined
}
out <- bind_rows(out_list) %>% mutate(sub_category = factor(sub_category, levels = rev(sort(unique(sub_category)))))
# Multiply by 1000
out <- out %>%
  mutate(rate = rate * 10000,
         lwr = lwr * 10000,
         upr = upr * 10000)
ggplot(data = out,
       aes(x = sub_category,
           y = rate,
           group = intervention,
           fill = intervention)) +
  geom_col(position = position_dodge(width = 0.9), color = 'black') +
  geom_errorbar(aes(ymin = lwr, ymax = upr), position = position_dodge(width = 0.9),
                alpha = 0.6) +
  theme_bw() +
  theme(legend.position = 'bottom') +
  coord_flip() +
  scale_fill_manual(name = '', values = c('darkgrey', 'red')) +
  labs(x = 'Symptom category',
       y = 'Rate (per 10,000 individuals)')
saex <- out
```


#### Rate ratios

```{r}
rr <- out %>%
  group_by(sub_category) %>%
  summarise(rr = rate[intervention == 'Treatment'] / rate[intervention == 'Control']) 
limiter <- max(abs(range(rr$rr)))
ggplot(data = rr,
       aes(x = sub_category,
           y = rr)) +
  # geom_col(alpha = 0.5) +
  geom_point(pch = '_', size = 10) +
  geom_hline(yintercept = 1, alpha = 0.8, lty = 2) +
  geom_text(aes(label = round(rr, digits = 4),
                y = ifelse(rr <0, rr-0.1, rr + 0.1))) +
  theme_bw() + 
    ylim(0, 1 + c(limiter*1.1)) +
  labs(x = '', y = 'Incidence rate ratio (Ivermectin / Albendazole)') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
rr_sae <- rr
```

## AEs by sub-category

```{r}
sub_categories <- sort(unique(ae$symptom_category))
out_list <- list()
for(i in 1:length(sub_categories)){
  this_sub_category <- sub_categories[i]
  this_ae <- ae %>%
    filter(symptom_category == this_sub_category)
  numerator <- this_ae %>% 
    # Get intervention
  mutate(cluster_number = as.numeric(substr(extid, 1, 2))) %>%
  left_join(assignments) %>%
  dplyr::rename(arm = assignment) %>%
  left_join(ia) %>%
  filter(!is.na(intervention)) %>%
  group_by(intervention) %>%
  summarise(aes = n()) 
  joined <- left_join(numerator, denominator) %>%
    mutate(rate = aes / people)
  ci <- binom.confint(x = joined$aes, n = joined$people, methods = 'wilson') %>%
  dplyr::select(upr = upper, lwr = lower)
  joined <- bind_cols(joined, ci)
  joined <- joined %>%
    mutate(sub_category = this_sub_category)
  out_list[[i]] <- joined
}
out <- bind_rows(out_list) %>% mutate(sub_category = factor(sub_category, levels = rev(sort(unique(sub_category)))))
out <- out %>%
  mutate(rate = rate * 10000,
         lwr = lwr * 10000,
         upr = upr * 10000)
ggplot(data = out,
       aes(x = sub_category,
           y = rate,
           group = intervention,
           fill = intervention)) +
  geom_col(position = position_dodge(width = 0.9), color = 'black') +
  geom_errorbar(aes(ymin = lwr, ymax = upr), position = position_dodge(width = 0.9),
                alpha = 0.6) +
  theme_bw() +
  theme(legend.position = 'bottom') +
  coord_flip() +
  scale_fill_manual(name = '', values = c('darkgrey', 'red')) +
  labs(x = 'Symptom category',
       y = 'Rate (per 10,000 individuals)')
aex <- out
```

#### Rate ratios

```{r}
rr <- out %>%
  group_by(sub_category) %>%
  summarise(rr = rate[intervention == 'Treatment'] / rate[intervention == 'Control']) 
limiter <- max(abs(range(rr$rr)))
ggplot(data = rr,
       aes(x = sub_category,
           y = rr)) +
  # geom_col(alpha = 0.5) +
  geom_point(pch = '_', size = 10) +
  geom_hline(yintercept = 1, alpha = 0.8, lty = 2) +
  geom_text(aes(label = round(rr, digits = 4),
                y = ifelse(rr <0, rr-0.1, rr + 0.1))) +
  theme_bw() + 
    ylim(0, 1 + c(limiter*1.1)) +
  labs(x = '', y = 'Incidence rate ratio (Ivermectin / Albendazole)') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
  
rr_ae <- rr
```

## Combined chart

```{r}
# saes overall
numerator <- saes %>% 
  group_by(intervention) %>%
  summarise(aes = n()) 
joined <- left_join(numerator, denominator) %>%
    mutate(rate = aes / people) 
ci <- binom.confint(x = joined$aes, n = joined$people, methods = 'wilson') %>%
  dplyr::select(upr = upper, lwr = lower)
  joined <- bind_cols(joined, ci)
  joined <- joined %>%
    mutate(sub_category = 'All SAEs')
sae_overall <- joined
rr_sae_overall <- sae_overall %>%
    group_by(sub_category) %>%
  summarise(rr = rate[intervention == 'Treatment'] / rate[intervention == 'Control']) 
  
# aes overall
numerator <- ae %>% 
 mutate(cluster_number = as.numeric(substr(extid, 1, 2))) %>%
  left_join(assignments) %>%
  dplyr::rename(arm = assignment) %>%
  left_join(ia) %>%
  filter(!is.na(intervention)) %>%
  group_by(intervention) %>%
  summarise(aes = n()) 
joined <- left_join(numerator, denominator) %>%
    mutate(rate = aes / people) 
ci <- binom.confint(x = joined$aes, n = joined$people, methods = 'wilson') %>%
  dplyr::select(upr = upper, lwr = lower)
joined <- bind_cols(joined, ci)
joined <- joined %>%
    mutate(sub_category = 'All AEs')
ae_overall <- joined
rr_ae_overall <- ae_overall %>%
  group_by(sub_category) %>%
  summarise(rr = rate[intervention == 'Treatment'] / rate[intervention == 'Control']) 
  

# Combine them all together
combined <-
  bind_rows(
    rr_sae_overall %>% mutate(grp = 'SAE'),
    rr_sae %>% mutate(grp = 'SAE'),
    rr_ae_overall %>% mutate(grp = 'AE'),
    rr_ae  %>% mutate(grp = 'AE')
  ) %>%
  mutate(sub_category = factor(sub_category, levels = sub_category)) %>%
  mutate(grp = factor(grp, levels = rev(sort(unique(grp)))))

# Get confidence intervals
# overall AE confidence intervals
# (reverse the order first so the comparison is compatible with the "combined" dataset)
ae_overall <- ae_overall %>% arrange(desc(intervention))
temp <- poisson.test(x = ae_overall$aes, T = ae_overall$people, r = 1)
ci_ae_overall <- tibble(lwr = temp$conf.int[1],
                        upr = temp$conf.int[2],
                        rr = temp$estimate,
                        p = temp$p.value,
                        sub_category = 'All AEs')
# AE sub-symptom confidence intervals
out_list <- list()
aex <- aex %>% arrange(desc(intervention))
sub_categories <- sort(unique(aex$sub_category))
for(i in 1:length(sub_categories)){
  this_sub_category <- sub_categories[i]
  this_data <- aex %>% filter(sub_category == this_sub_category)
  cix <- poisson.test(x = this_data$aes, T = this_data$people, r = 1)
  out <- tibble(lwr = cix$conf.int[1],
                upr = cix$conf.int[2],
                rr = cix$estimate,
                p = cix$p.value,
                sub_category = this_sub_category)
  out_list[[i]] <- out
}
ci_ae <- bind_rows(out_list)
# overall SAE confidence intervals
sae_overall <- sae_overall %>% arrange(desc(intervention))
temp <- poisson.test(x = sae_overall$aes, T = sae_overall$people, r = 1)
ci_sae_overall <- tibble(lwr = temp$conf.int[1],
                        upr = temp$conf.int[2],
                        rr = temp$estimate,
                        p = temp$p.value,
                        sub_category = 'All SAEs')
# SAE sub-symptom confidence intervals
out_list <- list()
saex <- saex %>% arrange(desc(intervention))
sub_categories <- sort(unique(saex$sub_category))
for(i in 1:length(sub_categories)){
  this_sub_category <- sub_categories[i]
  this_data <- saex %>% filter(sub_category == this_sub_category)
  cix <- poisson.test(x = this_data$aes, T = this_data$people, r = 1)
  out <- tibble(lwr = cix$conf.int[1],
                upr = cix$conf.int[2],
                rr = cix$estimate,
                p = cix$p.value,
                sub_category = this_sub_category)
  out_list[[i]] <- out
}
ci_sae <- bind_rows(out_list)
# Combine all confidence intervals into one
ci_combined <- bind_rows(
  ci_sae,
  ci_ae,
  ci_sae_overall,
  ci_ae_overall
) %>% dplyr::rename(rr2 = rr)
# joined to the other combined data
combined <- left_join(combined, ci_combined)
  
limiter <- max(abs(range(combined$upr)))
# ordering
# Rename per Carlos request
# https://bohemiakenya.slack.com/archives/C042KSRLYUA/p1718807586481569?thread_ts=1718714760.756079&cid=C042KSRLYUA
combined <- combined %>%
  mutate(sub_category = ifelse(sub_category == 'Malaria', 'Self-reported malaria', sub_category))
combined$sub_category <- factor(combined$sub_category, levels = combined$sub_category)

ggplot(data = combined,
       aes(x = sub_category,
           y = rr)) +
  # geom_col(alpha = 0.5) +
  geom_point(pch = '_', size = 20,
             aes(color = grp)) +
  geom_errorbar(aes(ymin = lwr, 
                    ymax = upr),
                width = 0.3,
                alpha = 0.4) +
  geom_hline(yintercept = 1, alpha = 0.7, size = 1, lty = 1) +
  geom_text(aes(label = round(rr, digits = 3),
                y = ifelse(rr <1, rr-0.1, rr + 0.1)), alpha = 0.5) +
  theme_bw() + 
    ylim(0, c(limiter*1.01)) +
  labs(x = '', y = 'Incidence rate ratio ivermectin/albendazole per 100 treated') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5)) +
  theme(legend.position = 'bottom') +
  scale_color_manual(name = '', values = c('red', 'blue'))
  
```

```{r}
out <- paste0(
  "There were ",
  nrow(ae),
  " AEs among ",
  length(unique(ae$extid)),
  " participants (",
  numerator2$aes[numerator2$intervention == 'Treatment'],
  " AEs in the ivermectin arm). The rate of AEs per 100 treated individuals was ",
  ae_overall %>% filter(intervention == 'Treatment') %>% mutate(r100 = round(aes / people * 100, digits = 2)) %>% mutate(r100 = paste0(r100, ' (95% CI of ', round(lwr * 100, digits = 2), ' - ', round(upr * 100, digits = 2), ')')) %>% pull(r100),
  " in the ivermectin and ",
  ae_overall %>% filter(intervention == 'Control') %>% mutate(r100 = round(aes / people * 100, digits = 2)) %>% mutate(r100 = paste0(r100, ' (95% CI of ', round(lwr * 100, digits = 2), ' - ', round(upr * 100, digits = 2), ')')) %>% pull(r100),
  " in the albendazole arm. The IRR for AEs was ",
  ci_ae_overall %>% mutate(output = paste0(round(rr, digits = 2), ' (95% CI of ', round(lwr, digits = 2), ' - ', round(upr, digits = 2), ')')) %>% pull(output),
  ". The IRR for AEs by body system is provided in Figure 3.
There were X pregnancies potentially exposed to the study drugs during the trial (Y in the ivermectin arm); these results are reported separately. There were ",
nrow(saes),

" non-pregnancy related SAEs in ",
length(unique(saes$extID)),
" participants, ",
length(which(!is.na(saes$`Event Death`))),
" deaths (",
saes %>% filter(!is.na(`Event Death`), intervention == 'Treatment')  %>% nrow(),
" in the ivermectin arm), ",
length(which(!is.na(saes$`Event Hospitalized`))),
" hospitalizations (",
saes %>% filter(!is.na(`Event Hospitalized`), intervention == 'Treatment')  %>% nrow(),
" in the ivermectin arm) and one ",
length(which(!is.na(saes$`Event Disability`))),
" disability (ivermectin arm). None were deemed drug-related by the medical monitors. The rate of SAE was ",
sae_overall %>% filter(intervention == 'Treatment') %>% mutate(r10000 = round(aes / people * 10000, digits = 2)) %>% mutate(r10000 = paste0(r10000, ' (95% CI of ', round(lwr * 10000, digits = 2), ' - ', round(upr * 10000, digits = 2), ')')) %>% pull(r10000),
" by 10,000 treated individuals in the ivermectin arm, and ",
sae_overall %>% filter(intervention == 'Control') %>% mutate(r10000 = round(aes / people * 10000, digits = 2)) %>% mutate(r10000 = paste0(r10000, ' (95% CI of ', round(lwr * 10000, digits = 2), ' - ', round(upr * 10000, digits = 2), ')')) %>% pull(r10000),
" in the albendazole arm. The IRR for SAEs was ",
ci_sae_overall %>% mutate(output = paste0(round(rr, digits = 2), ' (95% CI of ', round(lwr, digits = 2), ' - ', round(upr, digits = 2), ')')) %>% pull(output),
"."
)
cat(paste0(out))

# Carlos CSV request https://bohemiakenya.slack.com/archives/C042KSRLYUA/p1718786203357599?thread_ts=1718714760.756079&cid=C042KSRLYUA
carlos_csv <- 
  ae %>%
  left_join(safety_repeat_individual %>% dplyr::select(KEY, age, sex), by = c('PARENT_KEY' = 'KEY')) %>%
  # get intervention info
   mutate(cluster_number = as.numeric(substr(extid, 1, 2))) %>%
  left_join(assignments%>% mutate(cluster_number = as.numeric(cluster_number))) %>%
  dplyr::rename(arm = assignment) %>%
  left_join(ia) %>%
  filter(!is.na(intervention)) %>%
  dplyr::select(extid, sex, age, intervention, symptom, symptom_category)
write_csv(carlos_csv, 'ae_carlos.csv')
```



## Total events reported by visit

```{r}
ae %>%
  dplyr::select(-KEY) %>%
  left_join(visit_level) %>%
  group_by(visit) %>%
  tally %>%
  knitr::kable()
```

## Events by cluster / visit

The "V" variables refer to the visit at which the adverse event was reported.

```{r}
library(knitr)
library(kableExtra)

statuses <- left_join(assignments %>% 
                     dplyr::select(cluster = cluster_number,
                                   arm = assignment),
                   ia) %>%
  mutate(intervention = 'CENSORED')
# ad hoc chart for carlos april 8 2024
pdx <- ae %>%
    left_join(safety, by = c('safety_key' = 'KEY')) %>%
  left_join(statuses) 
# get percentage of affected subjects by arm and symptom
denominator <- safety_repeat_individual %>% dplyr::select(-intervention) %>%
  left_join(safety, by = c('PARENT_KEY' = 'KEY')) %>%
  left_join(statuses) %>%
  group_by(arm) %>%
  summarise(denom = length(unique(extid)))
left <- pdx %>% group_by(symptom_category, arm) %>%
  summarise(people = length(unique(extid)))
left <- left %>% left_join(denominator)
left <- left %>% filter(!is.na(arm)) %>%
  mutate(people = ifelse(is.na(people), 0, people))
left$p <- left$people / left$denom * 100
left$arm <- factor(left$arm)
ggplot(data = left,
       aes(x = symptom_category, y = p,
           fill = arm)) +
  geom_bar(stat = 'identity',
           position = position_dodge()) +
  theme_bw() +
  theme(legend.position = 'bottom') +
  labs(x = 'AE group',
       y = 'Percent of affected subjects')

pd <- ae %>%
  # dplyr::select(-KEY) %>%
  # left_join(visit_level) %>%
  left_join(safety, by = c('safety_key' = 'KEY')) %>%
  group_by(cluster, visit) %>%
  tally %>%
  ungroup 
# Get number of treated people
right <- safety_repeat_individual %>%
  filter(!is.na(num_ivermectin_tablets_taken) |
           !is.na(num_albendzole_pills)) %>%
  left_join(safety %>% dplyr::select(KEY, cluster, visit), by = c('PARENT_KEY' = 'KEY')) %>% 
  dplyr::select(cluster, extid, visit) %>%
  bind_rows(
    safetynew_repeat_individual  %>%
  filter(!is.na(num_ivermectin_tablets_taken) |
           !is.na(num_albendzole_pills)) %>%
  left_join(safetynew %>% dplyr::select(KEY, cluster, visit), by = c('PARENT_KEY' = 'KEY')) %>%
    dplyr::select(cluster, extid, visit)) %>%
  group_by(cluster, visit) %>%
  summarise(n_treated = n()) %>%
  ungroup %>%
  mutate(next_visit = paste0('V', as.numeric(gsub('V', '', visit)) + 1)) %>%
  dplyr::select(-visit)
pd <- full_join(pd, right, by = c('cluster', 'visit'='next_visit'))
pd <- pd %>% filter(!is.na(cluster), !is.na(visit))
pd <- pd %>% mutate(n = ifelse(is.na(n), 0, n),
                    n_treated = ifelse(is.na(n_treated), 0, n_treated))

pd <- pd %>%
  dplyr::rename(number_of_aes = n,
                n_treated_at_previous_visit = n_treated) %>%
  mutate(percentage_ae = number_of_aes / n_treated_at_previous_visit * 100)
pd <- pd %>% left_join(statuses)
pd$cluster <- add_zero(pd$cluster, 2)
pd <- pd %>% filter(!is.na(cluster))

# write csv for carlos
write_csv(pd, 'adverse_events_by_cluster.csv')
old_pd <- pd
old_pd %>%
  dplyr::select(cluster, visit, number_of_aes) %>%
  tidyr::spread(key = visit, value = number_of_aes) %>%
  # left_join(old_pd) %>%
  kable(format = "latex",
              longtable = TRUE,
              booktabs = TRUE,
             escape = TRUE,
          row.names = FALSE) %>%
      kable_styling(latex_options = c(#"scale_down",
                'repeat_header',

                                       "striped"
                                      ), 
                     # full_width = T,
                    font_size = 8) 
```


## Events by cluster / visit  / symptom category

```{r, fig.height = 8, fig.width=10}
pd <- ae %>%
  # dplyr::select(-KEY) %>%
  # left_join(visit_level) %>%
  left_join(safety, by = c('safety_key' = 'KEY')) %>%
  filter(!is.na(visit), !is.na(symptom_category)) %>%
  group_by(cluster, visit, symptom_category) %>%
  tally %>%
  ungroup %>%
  mutate(cluster = add_zero(cluster, 2)) %>%
  mutate(cluster = factor(cluster))
if(!dir.exists('for_carlos')){
  dir.create('for_carlos')
}
write_csv(pd, 'for_carlos/events_by_cluster_visit_symptom_category.csv')
ggplot(data = pd,
       aes(x = cluster,
           y = n)) +
  geom_bar(stat = 'identity',
           aes(fill = symptom_category),
           color = 'black',
           width = 1) +
  facet_wrap(~visit) +
  labs(x = 'Cluster',
       y = 'Events') +
  theme_bw() +
  coord_flip() +
  theme(legend.position = 'bottom') +
  scale_fill_manual(name = 'Symptom',
                    values = colorRampPalette(RColorBrewer::brewer.pal(n = 9, 'Set1'))(length(unique(pd$symptom_category))))
ggsave(filename = 'for_carlos/events_by_cluster_visit_symptom_category.png', height = 10, width = 10)

```



## Events by CL ID / visit

The "V" variables refer to the visit at which the adverse event was reported.

```{r}
library(knitr)
library(kableExtra)
# Read in intervention information
assignments <- read_csv('../randomization/outputs/assignments.csv')
ia <- read_csv('../randomization/outputs/intervention_assignment.csv')
statuses <- left_join(assignments %>% 
                     dplyr::select(cluster = cluster_number,
                                   arm = assignment),
                   ia) %>%
  mutate(intervention = 'CENSORED')
pd <- ae %>%
  # dplyr::select(-KEY) %>%
  # left_join(visit_level) %>%
  left_join(safety, by = c('safety_key' = 'KEY')) %>%
  group_by(wid, visit) %>%
  tally %>%
  ungroup 
# Get number of treated people
right <- safety_repeat_individual %>%
  filter(!is.na(num_ivermectin_tablets_taken) |
           !is.na(num_albendzole_pills)) %>%
  left_join(safety %>% dplyr::select(KEY, wid, visit), by = c('PARENT_KEY' = 'KEY')) %>% 
  dplyr::select(wid, extid, visit) %>%
  bind_rows(
    safetynew_repeat_individual  %>%
  filter(!is.na(num_ivermectin_tablets_taken) |
           !is.na(num_albendzole_pills)) %>%
  left_join(safetynew %>% dplyr::select(KEY, wid, visit), by = c('PARENT_KEY' = 'KEY')) %>%
    dplyr::select(wid, extid, visit)) %>%
  group_by(wid, visit) %>%
  summarise(n_treated = n()) %>%
  ungroup %>%
  mutate(next_visit = paste0('V', as.numeric(gsub('V', '', visit)) + 1)) %>%
  dplyr::select(-visit)
pd <- full_join(pd, right, by = c('wid', 'visit'='next_visit'))
pd <- pd %>% filter(!is.na(wid), !is.na(visit))
pd <- pd %>% mutate(n = ifelse(is.na(n), 0, n),
                    n_treated = ifelse(is.na(n_treated), 0, n_treated))

pd <- pd %>%
  dplyr::rename(number_of_aes = n,
                n_treated_at_previous_visit = n_treated) %>%
  mutate(percentage_ae = number_of_aes / n_treated_at_previous_visit * 100)
pd <- pd %>% filter(!is.na(wid))

# write csv for carlos
write_csv(pd, 'for_carlos/adverse_events_by_wid.csv')
old_pd <- pd
old_pd %>%
  dplyr::select(wid, visit, number_of_aes) %>%
  tidyr::spread(key = visit, value = number_of_aes) %>%
  # left_join(old_pd) %>%
  kable(format = "latex",
              longtable = TRUE,
              booktabs = TRUE,
             escape = TRUE,
          row.names = FALSE) %>%
      kable_styling(latex_options = c(#"scale_down",
                'repeat_header',

                                       "striped"
                                      ), 
                     # full_width = T,
                    font_size = 8) 
```


```{r}
library(knitr)
library(kableExtra)
# Read in intervention information
assignments <- read_csv('../randomization/outputs/assignments.csv')
ia <- read_csv('../randomization/outputs/intervention_assignment.csv')
statuses <- left_join(assignments %>% 
                     dplyr::select(cluster = cluster_number,
                                   arm = assignment),
                   ia) %>%
  mutate(intervention = 'CENSORED')
pd <- ae %>%
  left_join(safety_repeat_individual %>% dplyr::select(KEY, sex, age), by = c('PARENT_KEY' = 'KEY')) %>%
  # dplyr::select(-KEY) %>%
  # left_join(visit_level) %>%
  left_join(safety %>% dplyr::select(KEY, wid, cluster, visit), by = c('safety_key' = 'KEY')) %>%
  filter(!is.na(visit), !is.na(symptom_category)) %>%
  dplyr::select(visit, todays_date, extid, symptom_category, wid, cluster, sex, age) %>%
  left_join(statuses)
# write csv for carlos
write_csv(pd, 'for_carlos/aes_for_carlos.csv')
```


## Events by visit  / symptom category / CL ID

```{r, fig.height = 8, fig.width=10}
pd <- ae %>%
  # dplyr::select(-KEY) %>%
  # left_join(visit_level) %>%
  left_join(safety, by = c('safety_key' = 'KEY')) %>%
  filter(!is.na(visit), !is.na(symptom_category)) %>%
  mutate(wid = as.character(wid)) %>%
  group_by(wid, visit, symptom_category) %>%
  tally %>%
  ungroup 
write_csv(pd, 'for_carlos/events_by_visit_symptom_category_cl_id.csv')
ggplot(data = pd,
       aes(x = wid,
           y = n)) +
  geom_bar(stat = 'identity',
           aes(fill = symptom_category),
           # color = 'black',
           width = 1) +
  facet_grid(~visit) +
  labs(x = 'CL ID',
       y = 'Events') +
  theme_bw() +
  coord_flip() +
  theme(legend.position = 'bottom',
        axis.text.y = element_text(size = 2)) +
  scale_fill_manual(name = 'Symptom',
                    values = RColorBrewer::colorRampPalette(RColorBrewer::brewer.pal(n = 9, 'Set1'))(length(unique(pd$symptom_category))))
ggsave('for_carlos/events_by_visit_symptom_category_cl_id.png')

pdx <- tidyr::spread(pd, key = visit, value = n)
pdx %>%
    kable(format = "latex",
              longtable = TRUE,
              booktabs = TRUE,
             escape = TRUE,
          row.names = FALSE) %>%
      kable_styling(latex_options = c(#"scale_down",
                'repeat_header',

                                       "striped"
                                      ), 
                     # full_width = T,
                    font_size = 8) 
```

## Individuals with more than one AE

`r nrow(ae)` adverse events have been registered from `r length(unique(ae$extid))` individuals. The below chart shows the number of adverse events per individual.

```{r}
left <- safety_repeat_individual %>% distinct(extid)
right <- ae %>% group_by(extid) %>% tally
joined <- left_join(left, right) %>% mutate(n = ifelse(is.na(n), 0, n))
pd <- joined %>%
  group_by(n) %>%
  summarise(individuals = n())
ggplot(data = pd,
       aes(x = n,
           y = individuals)) +
  geom_bar(stat = 'identity') +
  geom_text(aes(label = individuals), nudge_y = 1000) +
  labs(x = 'Number of adverse events',
       y = 'Number of individuals with that many adverse events') +
  theme_bw() +
  scale_x_continuous(breaks = 1:max(pd$n))
```

The below table shows all cases of individuals who have registered 3 or more adverse events.

```{r}
pd <- ae %>%
    left_join(safety_repeat_individual %>% dplyr::select(KEY, sex, age), by = c('PARENT_KEY'= 'KEY')) %>%
  left_join(safety, by = c('safety_key' = 'KEY')) %>%
  filter(!is.na(visit), !is.na(symptom_category)) %>%
  mutate(visit_event = paste0(visit, ':', symptom_category)) %>%
  arrange(visit) %>%
  group_by(extid, sex, age) %>%
  summarise(n_ae = n(),
            visit_events = paste0(visit_event, collapse = ';')) %>%
  filter(n_ae >= 3)

pd %>%
      kable(format = "latex",
              longtable = TRUE,
              booktabs = TRUE,
             escape = TRUE,
          row.names = FALSE) %>%
      kable_styling(latex_options = c(#"scale_down",
                'repeat_header',

                                       "striped"
                                      ), 
                     # full_width = T,
                    font_size = 8) 
```


## Adverse event symptom categories

```{r}
pd <- ae %>%
  left_join(safety %>% dplyr::select(safety_key = KEY, visit)) %>%
  filter(!is.na(visit)) %>%
  group_by(symptom_category, visit) %>%
  tally %>%
  ungroup %>%
  group_by(visit) %>%
  mutate(p = n / sum(n) * 100)
ggplot(data = pd,
       aes(x = symptom_category,
           y = p)) +
  geom_bar(stat = 'identity',
           color = 'black',
           fill = 'lightblue',
           alpha = 0.5) +
  theme_bw() +
  labs(x = '',
       y = 'Percentage') +
  geom_text(aes(y = ifelse(p <= 10, p + (0.15 * max(p)), p - (0.17 * max(p))),
                label = paste0(n, '\n(', round(p, digits = 2), '%)') )) +
  facet_wrap(~visit) +
  coord_flip()
ggsave('for_carlos/adverse_event_symptom_categories.png', height = 10, width = 10)
```


## Adverse event symptom categories by visit

```{r}
ae %>%
  dplyr::select(-KEY) %>%
  left_join(visit_level) %>%
  group_by(visit, symptom_category) %>%
  tally %>%
  knitr::kable()
```

## Adverse events by sex

```{r}
ae %>%
  left_join(safety_repeat_individual %>% dplyr::distinct(extid, .keep_all = TRUE) %>%dplyr::select(extid, sex)) %>%
  filter(!is.na(sex)) %>%
  group_by(sex) %>%
  tally %>%
  knitr::kable()
```


## Adverse event symptom categories by sex

```{r}
px <- ae %>% 
    left_join(safety %>% dplyr::select(safety_key = KEY, visit)) %>%
  filter(!is.na(visit)) %>%
  left_join(safety_repeat_individual %>% dplyr::distinct(extid, .keep_all = TRUE) %>%dplyr::select(extid, sex))
pd <- px %>%
  group_by(symptom_category, sex, visit) %>%
  tally %>%
  ungroup %>%
  group_by(sex, visit) %>%
  mutate(p = n / sum(n) * 100) %>% ungroup
ggplot(data = pd,
       aes(x = symptom_category,
           y = p)) +
  geom_bar(stat = 'identity',
           color = 'black',
           fill = 'lightblue',
           alpha = 0.5) +
  theme_bw() +
  labs(x = '',
       y = 'Percentage') +
  geom_text(aes(y = p + (0.04 * max(p)),
                label = n )) +
  coord_flip() +
  facet_grid(visit~sex)
ggsave('for_carlos/adverse_event_symptom_categories_by_sex.png', height = 10, width = 10)
```


## Adverse event symptom categories by age group

```{r}
px <- ae %>% 
    left_join(safety %>% dplyr::select(safety_key = KEY, visit)) %>%
  filter(!is.na(visit)) %>%
  left_join(safety_repeat_individual %>% dplyr::distinct(extid, .keep_all = TRUE) %>%dplyr::select(extid, age)) %>%
  filter(!is.na(age)) %>%
  mutate(age_group = ifelse(age <= 5, '00-05',
                            ifelse(age <= 18,
                                   '05.01-18',
                                   ifelse(age <= 40,
                                          '18.01-40',
                                          ifelse(age < 65,
                                                 '40.01-65',
                                                 '65+')))))
pd <- px %>%
  group_by(symptom_category, age_group, visit) %>%
  tally %>%
  ungroup %>%
  group_by(age_group, visit) %>%
  mutate(p = n / sum(n) * 100) %>% ungroup
ggplot(data = pd,
       aes(x = symptom_category,
           y = p)) +
  geom_bar(stat = 'identity',
           color = 'black',
           fill = 'lightblue',
           alpha = 0.5) +
  theme_bw() +
  labs(x = '',
       y = 'Percentage') +
  geom_text(aes(y = p + (0.04 * max(p)),
                label = n )) +
  coord_flip() +
  facet_grid(visit~age_group)
ggsave('for_carlos/adverse_event_symptom_categories_by_age_group.png', height = 10, width = 10)
```


## Adverse events by treatment status

```{r}
px <- ae %>% 
    left_join(safety %>% dplyr::select(safety_key = KEY, visit)) %>%
  filter(!is.na(visit)) %>%
  dplyr::select(-PARENT_KEY) %>% 
  left_join(safety_repeat_individual %>% dplyr::distinct(extid, .keep_all = TRUE) %>% dplyr::select(PARENT_KEY, extid, intervention)) %>%
              left_join(safety %>% dplyr::select(KEY, hhid, cluster), by = c('PARENT_KEY' = 'KEY'))
pd <- px %>%
  filter(!is.na(intervention), !is.na(visit)) %>%
  group_by(intervention, visit) %>%
  tally %>%
  ungroup %>%
  group_by(visit) %>%
  mutate(p = n / sum(n) * 100) %>% ungroup
ggplot(data = pd,
       aes(x = intervention,
           y = p)) +
  geom_bar(stat = 'identity',
           color = 'black',
           fill = 'lightblue',
           alpha = 0.5) +
  theme_bw() +
  labs(x = '',
       y = 'Percentage') +
  geom_text(aes(y = p + (0.04 * max(p)),
                label = n )) +
  coord_flip() +
  facet_wrap(~visit)
ggsave('for_carlos/adverse_event_symptom_categories_by_treatment_status.png', height = 10, width = 10)
```


## Adverse events by treatment status and symptom category

```{r}
px <- ae %>%
    left_join(safety %>% dplyr::select(safety_key = KEY, visit)) %>%
  filter(!is.na(visit)) %>%
  dplyr::select(-PARENT_KEY) %>% 
  left_join(safety_repeat_individual %>% dplyr::distinct(extid, .keep_all = TRUE) %>% dplyr::select(PARENT_KEY, extid, intervention)) %>%
              left_join(safety %>% dplyr::select(KEY, hhid, cluster), by = c('PARENT_KEY' = 'KEY'))
pd <- px %>%
  group_by(intervention, symptom_category, visit) %>%
  tally %>%
  ungroup %>%
  group_by(intervention, visit) %>%
  mutate(p = n / sum(n) * 100) %>% ungroup
ggplot(data = pd,
       aes(x = intervention,
           y = p)) +
  geom_bar(stat = 'identity',
           color = 'black',
           fill = 'lightblue',
           alpha = 0.5) +
  theme_bw() +
  labs(x = '',
       y = 'Percentage') +
  geom_text(aes(y = p + (0.04 * max(p)),
                label = n )) +
  coord_flip() +
  facet_grid(visit~symptom_category)
```

## Adverse events by number of tablets ever taken

```{r}
# num_ivermectin_tablets_taken
# num_albendzole_pills

pills_ever_taken <-
  safety_repeat_individual %>%
  left_join(safety %>% dplyr::select(KEY, hhid, cluster, visit), by = c('PARENT_KEY' = 'KEY')) %>%
  mutate(n_pills = ifelse(!is.na(num_albendzole_pills),
                          num_albendzole_pills,
                          ifelse(!is.na(num_ivermectin_tablets_taken),
                                 num_ivermectin_tablets_taken, 0))) %>%
  group_by(extid, intervention) %>%
  summarise(n_pills = sum(n_pills))

px <- ae %>% 
    left_join(safety %>% dplyr::select(safety_key = KEY, visit)) %>%
  filter(!is.na(visit)) %>%
  left_join(pills_ever_taken) %>%
  group_by(intervention, n_pills, visit) %>%
  tally

ggplot(data = px,
       aes(x = n_pills,
           y = n)) +
  geom_line() +
  geom_point() +
  facet_grid(visit~intervention, scales = 'free_x') +
  labs(x = 'Total pills/tablets',
       y = 'Number of adverse events reported') +
  theme_bw()

```

## Adverse events at visit X by number of pills/tablets at visit X-1

```{r, fig.height = 7.5, fig.width = 10}
right <- visit_level %>%
    mutate(n_pills = ifelse(!is.na(num_albendzole_pills),
                          num_albendzole_pills,
                          ifelse(!is.na(num_ivermectin_tablets_taken),
                                 num_ivermectin_tablets_taken, 0))) %>%
  left_join(safety_repeat_individual %>% dplyr::select(intervention, extid) %>% dplyr::distinct(extid, .keep_all = TRUE)) %>%
  filter(!is.na(visit)) %>%
  dplyr::select(intervention, extid, visit, n_pills) %>%
  mutate(visit_joiner = visit) %>%
  dplyr::select(-visit)
left <- ae %>% 
  left_join(safety %>% dplyr::select(KEY, visit), by = c('safety_key'  = 'KEY')) %>%
  filter(!is.na(visit)) %>%
  mutate(visit_joiner = paste0('V', as.numeric(gsub('V', '', visit)) - 1)) 
joined <- left_join(left, right)  

model_data <- joined %>% 
  mutate(visit = paste0('AE reported at ', visit))

px <- model_data %>%
  group_by(intervention, n_pills, symptom_category, ae_reported_at = visit) %>%
  tally %>%
  ungroup
  
ggplot(data = px,
       aes(x = n_pills,
           y = n,
           color = intervention)) +
  geom_line() +
  geom_point() +
  facet_grid(ae_reported_at ~ symptom_category) +
  theme_bw() +
  theme(legend.position = 'bottom') +
  labs(x = 'Number of pills taken at prior visit',
       y = 'Number of adverse events')

```

## Modeling

```{r}
fit_data <- visit_level %>% dplyr::mutate(visit_joiner = visit)  %>% dplyr::select(-visit, -todays_date) %>%
  left_join(safety_repeat_individual %>% dplyr::select(extid, intervention) %>% dplyr::distinct(extid, .keep_all = TRUE)) %>%
  left_join(model_data %>% dplyr::select(-intervention)) %>%
  mutate(had_ae = !is.na(symptom_category))
library(mltools)
library(data.table)
fit_data <- fit_data %>%
  dplyr::select(extid, visit_joiner, intervention, symptom_category, had_ae) %>%
  mutate(symptom_category = factor(symptom_category))
fit_data <- one_hot(as.data.table(fit_data))

fit <- glm(had_ae ~ intervention, data = fit_data)
ors <- exp(coef(fit))
ci <- exp(confint(fit))
out <- data.frame(ors)
out$lwr <- ci[,1]
out$upr <- ci[,2]
```

### Odds ratio of having any adverse event as function of treatment vs control

```{r}
knitr::kable(out)
```

### Supporting table

```{r}
fit_data %>%
  group_by(had_ae, intervention) %>%
  tally %>%
  ungroup %>%
  group_by(intervention) %>%
  mutate(p = n / sum(n) * 100) %>%
  filter(!is.na(intervention)) %>%
  knitr::kable()
```


```{r, results = 'asis'}
cat('\\newpage')
```

# De-aggregated information

Individual-level information can be explored in two ways:

1. Using the below tables (one page = one individual)

2. Using the "adverse_events.csv" spreadsheet



```{r results='asis', eval = TRUE}  
cat('\n\n')
extids <- sort(unique(ae$extid))
for(i in 1:length(extids)){
  this_extid <- extids[i]
  this_ae <- ae %>% filter(extid == this_extid)
  # AE (principle table)
  table1 <- this_ae %>%
    # mutate(symptom_start = todays_date - lubridate::days(symptom_start),
    #        symptom_end = todays_date - lubridate::days(symptom_end)) %>%
    dplyr::select(extid, symptom,
                  symptom_category,
                  symptom_start, symptom_end,
                  symptom_still_have, 
                  symptom_seek_care, symptom_seek_care_where, seek_care_hospital_night,
                  num_nights_hospital,
                  todays_date) %>%
    dplyr::select(-extid)
  # Individual table
  table2 <- individuals %>%
    filter(extid == this_extid) %>%
    dplyr::select(-extid)
  # Visit table
  # get comedications
  individual_drugs <- drugs %>%
    mutate(drug = ifelse(!is.na(drug_other_specify),
                         drug_other_specify,
                         drug)) %>%
        filter(extid == this_extid) %>%
    dplyr::select(drug, still_taking_drug_yn, num_days_drug,
                  num_days_after_visit_drug_start, safety_key)
  comeds <- individual_drugs %>%
    left_join(safety %>% dplyr::select(visit, todays_date, KEY), by = c('safety_key' = 'KEY')) %>%
    group_by(visit) %>%
    summarise(drug = paste(drug, collapse = ', '))
  table3 <- visit_level %>%
    left_join(comeds) %>%
    filter(extid == this_extid) %>%
    dplyr::select(-extid) %>%
    arrange(visit)
  table3 <- t(table3)
  
  # Make kables
    k1 <- kable(table1, format = "latex",
              longtable = TRUE,
              booktabs = TRUE,
             escape = TRUE,
          row.names = FALSE) %>%
      kable_styling(latex_options = c(#"scale_down",
                'repeat_header',

                                       "striped"
                                      ), 
                     # full_width = T,
                    font_size = 5)
      k2 <- kable(table2, format = "latex",
              longtable = TRUE,
              booktabs = TRUE,
             escape = TRUE,
          row.names = FALSE) %>%
      kable_styling(latex_options = c(#"scale_down",
                'repeat_header',

                                       "striped"
                                      ), 
                     # full_width = T,
                    font_size = 7)
  
    k3 <- kable(table3, format = "latex",
              longtable = TRUE,
              booktabs = TRUE,
             escape = TRUE,
          row.names = TRUE) %>%
      kable_styling(latex_options = c("scale_down",
                'repeat_header',

                                       "striped"
                                      ))
    
      k4 <- kable(individual_drugs %>% dplyr::select(-safety_key), format = "latex",
              longtable = TRUE,
              booktabs = TRUE,
             escape = TRUE,
          row.names = TRUE) %>%
      kable_styling(latex_options = c("scale_down",
                'repeat_header',

                                       "striped"
                                      ))
    
      cat(paste0("\\fbox{\\parbox{5cm}{\\centering ", this_extid, '',  "}}\n\n"))
  cat(paste0("\\medskip\n\n"))
  cat(paste0('Participant details'))
  print(k1)
  cat(paste0("\\medskip\n\n"))
  cat(paste0('Adverse events'))
  print(k2)
  cat(paste0("\\medskip\n\n"))
  cat(paste0('Visit details'))
  print(k3)
  cat(paste0("\\medskip\n\n"))
  cat(paste0('Co-medications'))
  print(k4)
  cat('\\newpage')
    
}

```

```{r}
# Write a csv for analysis
out <- ae %>%
    left_join(safety_repeat_individual %>% dplyr::distinct(extid, .keep_all = TRUE) %>% dplyr::select(extid, sex, age, intervention)) %>%
  dplyr::select(extid, 
                hhid,
                sex, age, intervention,
                symptom_name,
                symptom_category,
                todays_date,
                symptom_still_have,
                symptom_started_days_after_visit = symptom_start,
                symptom_ended_days_after_visit = symptom_end,
                safety_key,
                symptom_interfere_activities,
                symptom_seek_care,
                symptom_seek_care_where,
                symptom_seek_care_other_specify,
                seek_care_hospital_night,
                note_hospital_night_sae,
                night_hospital_eos,
                num_nights_hospital,
                treatment_for_malaria,
                KEY)
write_csv(out, 'adverse_events_for_review.csv')
```

\cfoot{\thepage\ of \pageref{LastPage}}

