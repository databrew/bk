---
title: ""
output: 
  pdf_document:
    latex_engine: xelatex
header-includes:
- \usepackage{array}
- \usepackage{booktabs}
- \usepackage{threeparttablex}
- \usepackage{pdflscape}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \usepackage{lastpage}
- \usepackage{multirow}
- \usepackage{colortbl}
- \usepackage[labelformat = empty]{caption}
- \fancyhead[CO,CE]{Adverse events}
- \fancyfoot[CO,CE]{Date = \today\\}
- \fancyfoot[LE,RO]{Page {\thepage} of \pageref{LastPage}}
geometry: margin=2cm
classoption: landscape
params:
  vcs: 02A
always_allow_html: true
---

\thispagestyle{fancy}




```{r, eval = FALSE, echo = FALSE}
header-includes:
- \usepackage{booktabs}
- \usepackage{xcolor}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage{pdflscape}
- \usepackage{tabu}
- \usepackage[normalem]{ulem}
- \thispagestyle{empty}

```


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = NA, 
               echo = FALSE, 
               warning = FALSE, 
               message = FALSE, 
               error = TRUE, 
               cache = FALSE,
  fig.path = "figures/",
  out.width = "100%"
)
options(knitr.kable.NA = '')
library(knitr)
library(kableExtra)
```



```{r}
library(dplyr)
library(knitr)
options(digits=8)

library(kableExtra)
library(readr)
library(dplyr)
library(ggplot2)
# Define function for adding zero
add_zero <- function (x, n) {
  x <- as.character(x)
  adders <- n - nchar(x)
  adders <- ifelse(adders < 0, 0, adders)
  for (i in 1:length(x)) {
    if (!is.na(x[i])) {
      x[i] <- paste0(paste0(rep("0", adders[i]), collapse = ""),
                     x[i], collapse = "")
    }
  }
  return(x)
}
```

```{r}
# Read in data generated by generate_metadata.R
load('rmd_data.RData')
```

# Aggregated information

## Total events reported by visit

```{r}
ae %>%
  dplyr::select(-KEY) %>%
  left_join(visit_level) %>%
  group_by(visit) %>%
  tally %>%
  knitr::kable()
```

## Events by cluster / visit

The "V" variables refer to the visit at which the adverse event was reported.

```{r}
library(knitr)
library(kableExtra)
# Read in intervention information
assignments <- read_csv('../randomization/outputs/assignments.csv')
ia <- read_csv('../randomization/outputs/intervention_assignment.csv')
statuses <- left_join(assignments %>% 
                     dplyr::select(cluster = cluster_number,
                                   arm = assignment),
                   ia) %>%
  mutate(intervention = 'CENSORED')
pd <- ae %>%
  # dplyr::select(-KEY) %>%
  # left_join(visit_level) %>%
  left_join(safety, by = c('safety_key' = 'KEY')) %>%
  group_by(cluster, visit) %>%
  tally %>%
  ungroup 
# Get number of treated people
right <- safety_repeat_individual %>%
  filter(!is.na(num_ivermectin_tablets_taken) |
           !is.na(num_albendzole_pills)) %>%
  left_join(safety %>% dplyr::select(KEY, cluster, visit), by = c('PARENT_KEY' = 'KEY')) %>% 
  dplyr::select(cluster, extid, visit) %>%
  bind_rows(
    safetynew_repeat_individual  %>%
  filter(!is.na(num_ivermectin_tablets_taken) |
           !is.na(num_albendzole_pills)) %>%
  left_join(safetynew %>% dplyr::select(KEY, cluster, visit), by = c('PARENT_KEY' = 'KEY')) %>%
    dplyr::select(cluster, extid, visit)) %>%
  group_by(cluster, visit) %>%
  summarise(n_treated = n()) %>%
  ungroup %>%
  mutate(next_visit = paste0('V', as.numeric(gsub('V', '', visit)) + 1)) %>%
  dplyr::select(-visit)
pd <- full_join(pd, right, by = c('cluster', 'visit'='next_visit'))
pd <- pd %>% filter(!is.na(cluster), !is.na(visit))
pd <- pd %>% mutate(n = ifelse(is.na(n), 0, n),
                    n_treated = ifelse(is.na(n_treated), 0, n_treated))

pd <- pd %>%
  dplyr::rename(number_of_aes = n,
                n_treated_at_previous_visit = n_treated) %>%
  mutate(percentage_ae = number_of_aes / n_treated_at_previous_visit * 100)
pd <- pd %>% left_join(statuses)
pd$cluster <- add_zero(pd$cluster, 2)
pd <- pd %>% filter(!is.na(cluster))

# write csv for carlos
write_csv(pd, 'adverse_events_by_cluster.csv')
old_pd <- pd
old_pd %>%
  dplyr::select(cluster, visit, number_of_aes) %>%
  tidyr::spread(key = visit, value = number_of_aes) %>%
  # left_join(old_pd) %>%
  kable(format = "latex",
              longtable = TRUE,
              booktabs = TRUE,
             escape = TRUE,
          row.names = FALSE) %>%
      kable_styling(latex_options = c(#"scale_down",
                'repeat_header',

                                       "striped"
                                      ), 
                     # full_width = T,
                    font_size = 8) 
```


## Events by cluster / visit  / symptom category

```{r, fig.height = 8, fig.width=10}
pd <- ae %>%
  # dplyr::select(-KEY) %>%
  # left_join(visit_level) %>%
  left_join(safety, by = c('safety_key' = 'KEY')) %>%
  group_by(cluster, visit, symptom_category) %>%
  tally %>%
  ungroup %>%
  mutate(cluster = add_zero(cluster, 2)) %>%
  mutate(cluster = factor(cluster))
ggplot(data = pd,
       aes(x = cluster,
           y = n)) +
  geom_bar(stat = 'identity',
           aes(fill = symptom_category),
           color = 'black',
           width = 1) +
  facet_wrap(~visit) +
  labs(x = 'Cluster',
       y = 'Events') +
  theme_bw() +
  coord_flip() +
  theme(legend.position = 'bottom') +
  scale_fill_manual(name = 'Symptom',
                    values = RColorBrewer::brewer.pal(n = length(unique(pd$symptom_category)), 'Set1'))

```

## Adverse event symptom categories

```{r}
pd <- ae %>%
  group_by(symptom_category) %>%
  tally %>%
  ungroup %>%
  mutate(p = n / sum(n) * 100)
ggplot(data = pd,
       aes(x = symptom_category,
           y = p)) +
  geom_bar(stat = 'identity',
           color = 'black',
           fill = 'lightblue',
           alpha = 0.5) +
  theme_bw() +
  labs(x = '',
       y = 'Percentage') +
  geom_text(aes(y = p + (0.04 * max(p)),
                label = n )) +
  coord_flip()
```


## Adverse event symptom categories by visit

```{r}
ae %>%
  dplyr::select(-KEY) %>%
  left_join(visit_level) %>%
  group_by(visit, symptom_category) %>%
  tally %>%
  knitr::kable()
```

## Adverse events by sex

```{r}
ae %>%
  left_join(safety_repeat_individual %>% dplyr::distinct(extid, .keep_all = TRUE) %>%dplyr::select(extid, sex)) %>%
  group_by(sex) %>%
  tally %>%
  knitr::kable()
```


## Adverse event symptom categories by sex

```{r}
px <- ae %>% left_join(safety_repeat_individual %>% dplyr::distinct(extid, .keep_all = TRUE) %>%dplyr::select(extid, sex))
pd <- px %>%
  group_by(symptom_category, sex) %>%
  tally %>%
  ungroup %>%
  group_by(sex) %>%
  mutate(p = n / sum(n) * 100) %>% ungroup
ggplot(data = pd,
       aes(x = symptom_category,
           y = p)) +
  geom_bar(stat = 'identity',
           color = 'black',
           fill = 'lightblue',
           alpha = 0.5) +
  theme_bw() +
  labs(x = '',
       y = 'Percentage') +
  geom_text(aes(y = p + (0.04 * max(p)),
                label = n )) +
  coord_flip() +
  facet_wrap(~sex)
```


## Adverse event symptom categories by age group

```{r}
px <- ae %>% left_join(safety_repeat_individual %>% dplyr::distinct(extid, .keep_all = TRUE) %>%dplyr::select(extid, age)) %>%
  mutate(age_group = ifelse(age <= 5, '00-05',
                            ifelse(age <= 18,
                                   '05.01-18',
                                   ifelse(age <= 40,
                                          '18.01-40',
                                          ifelse(age <- 65,
                                                 '40.01-65',
                                                 '65+')))))
pd <- px %>%
  group_by(symptom_category, age_group) %>%
  tally %>%
  ungroup %>%
  group_by(age_group) %>%
  mutate(p = n / sum(n) * 100) %>% ungroup
ggplot(data = pd,
       aes(x = symptom_category,
           y = p)) +
  geom_bar(stat = 'identity',
           color = 'black',
           fill = 'lightblue',
           alpha = 0.5) +
  theme_bw() +
  labs(x = '',
       y = 'Percentage') +
  geom_text(aes(y = p + (0.04 * max(p)),
                label = n )) +
  coord_flip() +
  facet_wrap(~age_group)
```


## Adverse events by treatment status

```{r}
px <- ae %>% dplyr::select(-PARENT_KEY) %>% 
  left_join(safety_repeat_individual %>% dplyr::distinct(extid, .keep_all = TRUE) %>% dplyr::select(PARENT_KEY, extid, intervention)) %>%
              left_join(safety %>% dplyr::select(KEY, hhid, cluster), by = c('PARENT_KEY' = 'KEY'))
pd <- px %>%
  group_by(intervention) %>%
  tally %>%
  ungroup %>%
  mutate(p = n / sum(n) * 100) %>% ungroup
ggplot(data = pd,
       aes(x = intervention,
           y = p)) +
  geom_bar(stat = 'identity',
           color = 'black',
           fill = 'lightblue',
           alpha = 0.5) +
  theme_bw() +
  labs(x = '',
       y = 'Percentage') +
  geom_text(aes(y = p + (0.04 * max(p)),
                label = n )) +
  coord_flip() 
```


## Adverse events by treatment status and symptom category

```{r}
px <- ae %>% dplyr::select(-PARENT_KEY) %>% 
  left_join(safety_repeat_individual %>% dplyr::distinct(extid, .keep_all = TRUE) %>% dplyr::select(PARENT_KEY, extid, intervention)) %>%
              left_join(safety %>% dplyr::select(KEY, hhid, cluster), by = c('PARENT_KEY' = 'KEY'))
pd <- px %>%
  group_by(intervention, symptom_category) %>%
  tally %>%
  ungroup %>%
  group_by(intervention) %>%
  mutate(p = n / sum(n) * 100) %>% ungroup
ggplot(data = pd,
       aes(x = intervention,
           y = p)) +
  geom_bar(stat = 'identity',
           color = 'black',
           fill = 'lightblue',
           alpha = 0.5) +
  theme_bw() +
  labs(x = '',
       y = 'Percentage') +
  geom_text(aes(y = p + (0.04 * max(p)),
                label = n )) +
  coord_flip() +
  facet_wrap(~symptom_category)
```

## Adverse events by number of tablets ever taken

```{r}
# num_ivermectin_tablets_taken
# num_albendzole_pills

pills_ever_taken <-
  safety_repeat_individual %>%
  left_join(safety %>% dplyr::select(KEY, hhid, cluster, visit), by = c('PARENT_KEY' = 'KEY')) %>%
  mutate(n_pills = ifelse(!is.na(num_albendzole_pills),
                          num_albendzole_pills,
                          ifelse(!is.na(num_ivermectin_tablets_taken),
                                 num_ivermectin_tablets_taken, 0))) %>%
  group_by(extid, intervention) %>%
  summarise(n_pills = sum(n_pills))

px <- ae %>% 
  left_join(pills_ever_taken) %>%
  group_by(intervention, n_pills) %>%
  tally

ggplot(data = px,
       aes(x = n_pills,
           y = n)) +
  geom_line() +
  geom_point() +
  facet_wrap(~intervention, scales = 'free_x') +
  labs(x = 'Total pills/tablets',
       y = 'Number of adverse events reported') +
  theme_bw()

```

## Adverse events at visit X by number of pills/tablets at visit X-1

```{r, fig.height = 7.5, fig.width = 10}
right <- visit_level %>%
    mutate(n_pills = ifelse(!is.na(num_albendzole_pills),
                          num_albendzole_pills,
                          ifelse(!is.na(num_ivermectin_tablets_taken),
                                 num_ivermectin_tablets_taken, 0))) %>%
  left_join(safety_repeat_individual %>% dplyr::select(intervention, extid) %>% dplyr::distinct(extid, .keep_all = TRUE)) %>%
  dplyr::select(intervention, extid, visit, n_pills) %>%
  mutate(visit_joiner = visit) %>%
  dplyr::select(-visit)
left <- ae %>% 
  left_join(safety %>% dplyr::select(KEY, visit), by = c('safety_key'  = 'KEY')) %>%
  mutate(visit_joiner = paste0('V', as.numeric(gsub('V', '', visit)) - 1)) 
joined <- left_join(left, right)  

model_data <- joined %>% 
  mutate(visit = paste0('AE reported at ', visit))

px <- model_data %>%
  group_by(intervention, n_pills, symptom_category, ae_reported_at = visit) %>%
  tally %>%
  ungroup
  
ggplot(data = px,
       aes(x = n_pills,
           y = n,
           color = intervention)) +
  geom_line() +
  geom_point() +
  facet_grid(ae_reported_at ~ symptom_category) +
  theme_bw() +
  theme(legend.position = 'bottom') +
  labs(x = 'Number of pills taken at prior visit',
       y = 'Number of adverse events')

```

## Modeling

```{r}
fit_data <- visit_level %>% dplyr::mutate(visit_joiner = visit)  %>% dplyr::select(-visit, -todays_date) %>%
  left_join(safety_repeat_individual %>% dplyr::select(extid, intervention) %>% dplyr::distinct(extid, .keep_all = TRUE)) %>%
  left_join(model_data %>% dplyr::select(-intervention)) %>%
  mutate(had_ae = !is.na(symptom_category))
library(mltools)
library(data.table)
fit_data <- fit_data %>%
  dplyr::select(extid, visit_joiner, intervention, symptom_category, had_ae) %>%
  mutate(symptom_category = factor(symptom_category))
fit_data <- one_hot(as.data.table(fit_data))

fit <- glm(had_ae ~ intervention, data = fit_data)
ors <- exp(coef(fit))
ci <- exp(confint(fit))
out <- data.frame(ors)
out$lwr <- ci[,1]
out$upr <- ci[,2]
```

### Odds ratio of having any adverse event as function of treatment vs control

```{r}
knitr::kable(out)
```

### Supporting table

```{r}
fit_data %>%
  group_by(had_ae, intervention) %>%
  tally %>%
  ungroup %>%
  group_by(intervention) %>%
  mutate(p = n / sum(n) * 100) %>%
  filter(!is.na(intervention)) %>%
  knitr::kable()
```


```{r, results = 'asis'}
cat('\\newpage')
```

# De-aggregated information

Individual-level information can be explored in two ways:

1. Using the below tables (one page = one individual)

2. Using the "adverse_events.csv" spreadsheet



```{r results='asis', eval = TRUE}  
cat('\n\n')
extids <- sort(unique(ae$extid))
for(i in 1:length(extids)){
  this_extid <- extids[i]
  this_ae <- ae %>% filter(extid == this_extid)
  # AE (principle table)
  table1 <- this_ae %>%
    mutate(symptom_start = todays_date - lubridate::days(symptom_start),
           symptom_end = todays_date - lubridate::days(symptom_end)) %>%
    dplyr::select(extid, symptom,
                  symptom_category,
                  symptom_start, symptom_end,
                  symptom_still_have, 
                  symptom_seek_care, symptom_seek_care_where, seek_care_hospital_night,
                  num_nights_hospital,
                  todays_date) %>%
    dplyr::select(-extid)
  # Individual table
  table2 <- individuals %>%
    filter(extid == this_extid) %>%
    dplyr::select(-extid)
  # Visit table
  # get comedications
  individual_drugs <- drugs %>%
    mutate(drug = ifelse(!is.na(drug_other_specify),
                         drug_other_specify,
                         drug)) %>%
        filter(extid == this_extid) %>%
    dplyr::select(drug, still_taking_drug_yn, num_days_drug,
                  num_days_after_visit_drug_start, safety_key)
  comeds <- individual_drugs %>%
    left_join(safety %>% dplyr::select(visit, todays_date, KEY), by = c('safety_key' = 'KEY')) %>%
    group_by(visit) %>%
    summarise(drug = paste(drug, collapse = ', '))
  table3 <- visit_level %>%
    left_join(comeds) %>%
    filter(extid == this_extid) %>%
    dplyr::select(-extid) %>%
    arrange(visit)
  table3 <- t(table3)
  
  # Make kables
    k1 <- kable(table1, format = "latex",
              longtable = TRUE,
              booktabs = TRUE,
             escape = TRUE,
          row.names = FALSE) %>%
      kable_styling(latex_options = c(#"scale_down",
                'repeat_header',

                                       "striped"
                                      ), 
                     # full_width = T,
                    font_size = 5)
      k2 <- kable(table2, format = "latex",
              longtable = TRUE,
              booktabs = TRUE,
             escape = TRUE,
          row.names = FALSE) %>%
      kable_styling(latex_options = c(#"scale_down",
                'repeat_header',

                                       "striped"
                                      ), 
                     # full_width = T,
                    font_size = 7)
  
    k3 <- kable(table3, format = "latex",
              longtable = TRUE,
              booktabs = TRUE,
             escape = TRUE,
          row.names = TRUE) %>%
      kable_styling(latex_options = c("scale_down",
                'repeat_header',

                                       "striped"
                                      ))
    
      k4 <- kable(individual_drugs %>% dplyr::select(-safety_key), format = "latex",
              longtable = TRUE,
              booktabs = TRUE,
             escape = TRUE,
          row.names = TRUE) %>%
      kable_styling(latex_options = c("scale_down",
                'repeat_header',

                                       "striped"
                                      ))
    
      cat(paste0("\\fbox{\\parbox{5cm}{\\centering ", this_extid, '',  "}}\n\n"))
  cat(paste0("\\medskip\n\n"))
  cat(paste0('Participant details'))
  print(k1)
  cat(paste0("\\medskip\n\n"))
  cat(paste0('Adverse events'))
  print(k2)
  cat(paste0("\\medskip\n\n"))
  cat(paste0('Visit details'))
  print(k3)
  cat(paste0("\\medskip\n\n"))
  cat(paste0('Co-medications'))
  print(k4)
  cat('\\newpage')
    
}

```

```{r}
# Write a csv for analysis
out <- ae %>%
    left_join(safety_repeat_individual %>% dplyr::distinct(extid, .keep_all = TRUE) %>% dplyr::select(extid, sex, age, intervention)) %>%
  dplyr::select(extid, 
                hhid,
                sex, age, intervention,
                symptom_name,
                symptom_category,
                todays_date,
                symptom_still_have,
                symptom_started_days_after_visit = symptom_start,
                symptom_ended_days_after_visit = symptom_end,
                safety_key,
                symptom_interfere_activities,
                symptom_seek_care,
                symptom_seek_care_where,
                symptom_seek_care_other_specify,
                seek_care_hospital_night,
                note_hospital_night_sae,
                night_hospital_eos,
                num_nights_hospital,
                treatment_for_malaria,
                KEY)
write_csv(out, 'adverse_events_for_review.csv')
```

\cfoot{\thepage\ of \pageref{LastPage}}

